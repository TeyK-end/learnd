<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sơ Đồ Tư Duy — Học Nhanh</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #0f172a;
        --muted: #1e293b;
        --line: #334155;
        --text: #e2e8f0;
        --soft: #94a3b8;
        --accent: #22c55e;
        --accent-2: #38bdf8;
        --warn: #f59e0b;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html, body {
        height: 100%;
        overflow: hidden;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, "Helvetica Neue", Arial;
        color: var(--text);
        background: radial-gradient(1200px 800px at 70% -20%, #172554 0%, #0b1020 50%, #070a17 100%);
      }
      .app {
        display: flex;
        flex-direction: row;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }
      aside {
        width: 320px;
        min-width: 200px;
        position: absolute;
        top: 0;
        left: -320px;
        height: 100%;
        background: var(--panel);
        transition: left 0.3s ease;
        z-index: 10;
        overflow-y: auto;
      }
      aside.visible {
        left: 0;
      }
      .sidebar-toggle {
        position: absolute;
        top: 20px;
        left: 0;
        background: var(--muted);
        border: none;
        color: var(--text);
        padding: 8px;
        cursor: pointer;
        border-radius: 0 8px 8px 0;
        z-index: 11;
      }
      main.stage {
        flex-grow: 1;
        overflow: hidden;
        position: relative;
        width: 100%;
      }
      svg {
        width: 100%;
        height: 100%;
        display: block;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
      }
      .brand svg {
        width: 28px;
        height: 28px;
      }
      .brand h1 {
        font-size: 18px;
        margin: 0;
      }
      .toolbar {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
        align-items: center;
        padding: 10px;
      }
      .btn {
        border: none;
        border-radius: 12px;
        background: var(--muted);
        color: var(--text);
        padding: 8px 12px;
        cursor: pointer;
      }
      .btn:hover {
        filter: brightness(1.1);
      }
      .btn.small {
        padding: 6px 10px;
        font-size: 12px;
      }
      .input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #12203c;
        background: #0a1327;
        color: var(--text);
      }
      .pill {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #0a142b;
        border: 1px solid #13213e;
        color: var(--soft);
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .stack {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .panel {
        background: #0a142b;
        border: 1px solid #13213e;
        border-radius: 16px;
        padding: 10px;
        margin: 10px 0;
      }
      .list {
        max-height: 32vh;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .list .item {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px;
        border-radius: 12px;
        background: #09132a;
        border: 1px solid #13213e;
      }
      .item .meta {
        font-size: 12px;
        color: var(--soft);
      }
      .item .right {
        margin-left: auto;
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .link {
        stroke: var(--line);
        stroke-width: 2px;
        opacity: 0.75;
      }
      .node {
        cursor: pointer;
      }
      .node:hover .bubble {
        filter: drop-shadow(0 0 10px rgba(56, 189, 248, 0.4));
      }
      .bubble {
        fill: url(#bubbleGrad);
        stroke: #1b2a48;
        stroke-width: 1.2;
      }
      .label {
        fill: var(--text);
        font-size: 12px;
        text-anchor: middle;
        dominant-baseline: central;
        pointer-events: none;
      }
      .badge {
        fill: #0b162e;
        stroke: #22406e;
        stroke-width: 1;
      }
      .hud {
        position: absolute;
        inset: 12px;
        pointer-events: none;
      }
      .hud .float {
        pointer-events: auto;
      }
      .zoombar {
        position: absolute;
        right: 8px;
        top: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        z-index: 10;
      }
      .fc-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 16px;
        z-index: 100;
        display: none;
        max-height: 80vh;
        overflow-y: auto;
      }
      .fc-overlay.visible {
        display: block;
      }
      .fc .card {
        background: linear-gradient(145deg, #0b162e, #0a142b);
        border: 1px solid #13213e;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
      }
      .fc .big {
        font-size: 22px;
        font-weight: bold;
        text-align: center;
        color: var(--accent);
      }
      .fc .image-container {
        max-width: 100%;
        max-height: 250px;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      .fc .muted {
        font-size: 14px;
        text-align: center;
        color: var(--soft);
      }
      .flashcard-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      .flashcard-image:hover {
        transform: scale(1.05);
      }
      .zoomed-image-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 101;
        overflow: auto;
      }
      .zoomed-image-container {
        position: relative;
        max-width: 90%;
        max-height: 90%;
      }
      .zoomed-image-container img {
        width: 100%;
        height: auto;
        border-radius: 8px;
      }
      .zoomed-image-container .close-zoom {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--danger);
        color: var(--text);
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        cursor: pointer;
      }
      .zoomed-image-container .close-zoom:hover {
        filter: brightness(1.2);
      }
      .quiz-section {
        margin-top: 20px;
        display: none;
      }
      .quiz-section.visible {
        display: block;
      }
      dialog {
        background: #071129;
        color: var(--text);
        border: 1px solid #1a2a4a;
        border-radius: 16px;
        width: min(720px, 86vw);
      }
      dialog .input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #142549;
        background: #061026;
        color: var(--text);
      }
      dialog::backdrop {
        background: rgba(2, 6, 23, 0.6);
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--muted);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--soft);
      }
      ::-webkit-scrollbar-track {
        background: #0a1327;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside id="sidebar">
        <div class="brand">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3l2.5 5 5 .7-3.7 3.6.9 5-4.7-2.6L7.3 17l.9-5L4.5 8.7l5-.7L12 3z" stroke="url(#g)" stroke-width="1.2" />
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="24" y2="24">
                <stop stop-color="#22c55e" />
                <stop offset="1" stop-color="#38bdf8" />
              </linearGradient>
            </defs>
          </svg>
          <h1>Sơ Đồ Tư Duy — Học Nhanh</h1>
        </div>
        <div class="toolbar">
          <input id="search" class="input" placeholder="Tìm nút (Ctrl/Cmd + K)" />
          <button id="btnReset" class="btn small" title="Đưa về vị trí mặc định">Reset</button>
          <button id="saveJson" class="btn small">Lưu JSON</button>
        </div>
        <div class="panel stack">
          <div class="row" style="justify-content: space-between">
            <span class="pill">Danh sách nút</span>
            <div class="tiny">Nhấn <span class="kbd">Space</span> để gập/mở nhánh</div>
          </div>
          <div id="list" class="list"></div>
        </div>
        <div class="panel stack">
          <div class="row" style="justify-content: space-between">
            <span class="pill">Chế độ thẻ nhớ (Flashcard)</span>
            <div class="tiny">Chọn một nút &gt; Học</div>
          </div>
          <div class="row">
            <select id="subtreeSelect" class="input" style="flex: 1"></select>
            <button id="btnStudy" class="btn">Học</button>
          </div>
          <div class="row">
            <button id="btnQuiz" class="btn">Kiểm tra</button>
          </div>
        </div>
        <div class="tiny">Mẹo: Kéo nền để pan.</div>
      </aside>
      <button id="toggleSidebar" class="sidebar-toggle">▶</button>
      <main class="stage">
        <div class="hud">
          <div class="float zoombar">
            <button class="btn small" id="zoomOut">-</button>
            <div class="pill" id="zoomLabel">100%</div>
            <button class="btn small" id="zoomIn">+</button>
            <button class="btn small" id="zoomReset">Reset</button>
          </div>
        </div>
        <svg id="svg" aria-label="mindmap canvas">
          <defs>
            <linearGradient id="bubbleGrad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#0ea5e9" stop-opacity="0.22" />
              <stop offset="100%" stop-color="#22c55e" stop-opacity="0.22" />
            </linearGradient>
            <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
              <path d="M0,0 L10,5 L0,10 z" fill="#2a3d60" />
            </marker>
          </defs>
          <g id="viewport" transform="translate(0,0)">
            <g id="mindmap" transform="scale(1)">
              <g id="links"></g>
              <g id="nodes"></g>
            </g>
          </g>
        </svg>
      </main>
    </div>
    <div id="fc-overlay" class="fc-overlay">
      <div id="fc" class="fc"></div>
      <div id="quiz-section" class="quiz-section">
        <h3>Câu hỏi trắc nghiệm</h3>
        <div id="quiz-questions"></div>
        <div class="row" style="margin-top: 16px; gap: 12px; justify-content: center;">
          <button id="quiz-submit" class="btn">Nộp</button>
        </div>
      </div>
      <button id="close-fc" class="btn">Đóng</button>
    </div>
    <dialog id="modalEdit">
      <form method="dialog" class="stack">
        <strong>Sửa nút</strong>
        <input id="editTitle" class="input" placeholder="Tiêu đề" required />
        <input id="editIcon" class="input" placeholder="Emoji hoặc link ảnh" />
        <input id="editNote" class="input" placeholder="Ghi chú" />
        <input id="editImg" class="input" placeholder="Link ảnh" />
        <div class="stack" id="questionFields">
          <button type="button" id="addQuestion" class="btn small">Thêm câu hỏi</button>
        </div>
        <menu>
          <button value="cancel">Hủy</button>
          <button id="btnEditNodeModal" value="default">Lưu</button>
        </menu>
      </form>
    </dialog>
    <script>
const state = {
  data: null,
  selectedId: null,
  scale: 1,
  tx: 0,
  ty: 0,
  panning: false,
  ctrlZoomOnly: true,
};

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

async function load() {
  try {
    // Load data from localStorage first
    const savedData = localStorage.getItem("mindmap_unity_v1");
    if (savedData) {
      state.data = JSON.parse(savedData);
    } else {
      const response = await fetch("sample_data.json");
      if (!response.ok) throw new Error("Không thể tải file JSON");
      state.data = await response.json();
    }
  } catch (err) {
    console.error("Lỗi khi tải dữ liệu:", err);
    state.data = {
      id: "root",
      title: "Nút gốc mới",
      icon: "🌱",
      note: "Dữ liệu mặc định",
      x: 0,
      y: 0,
      collapsed: false,
      learned: false,
      children: [],
      questions: [],
    };
    alert("Không thể tải file sample_data.json. Đã sử dụng dữ liệu mặc định.");
  }
}

function save() {
  localStorage.setItem("mindmap_unity_v1", JSON.stringify(state.data));
}

function downloadFile() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.data, null, 2));
  const downloadAnchorNode = document.createElement("a");
  downloadAnchorNode.setAttribute("href", dataStr);
  downloadAnchorNode.setAttribute("download", "sample_data.json");
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  document.body.removeChild(downloadAnchorNode);
}

function walk(node, fn, parent = null, depth = 0) {
  fn(node, parent, depth);
  (node.children || []).forEach((c) => walk(c, fn, node, depth + 1));
}

function findById(id) {
  let res = null;
  walk(state.data, (n) => {
    if (n.id === id) res = n;
  });
  return res;
}

function findParent(id) {
  let parent = null;
  walk(state.data, (n, p) => {
    if (n.id === id) parent = p;
  });
  return parent;
}

function autoLayout() {
  const layers = [];
  walk(state.data, (n, p, d) => {
    layers[d] = layers[d] || [];
    layers[d].push(n);
  });
  const R = 400; // Increased radius for more spacing
  const spacingMultiplier = 2.0; // Increased spacing between nodes
  layers.forEach((layer, d) => {
    const radius = d * R;
    const count = Math.max(1, layer.length);
    layer.forEach((node, i) => {
      if (typeof node.x === "number" && typeof node.y === "number" && !(node.x === 0 && node.y === 0)) return;
      const angle = (i / count) * Math.PI * 2 + (d % 2 ? 0.2 : 0);
      node.x = Math.cos(angle) * radius * spacingMultiplier;
      node.y = Math.sin(angle) * radius * spacingMultiplier;
    });
  });
}

const svg = $("#svg");
const viewport = $("#viewport");
const gLinks = $("#links");
const gNodes = $("#nodes");

function render() {
  autoLayout();
  gLinks.innerHTML = "";
  gNodes.innerHTML = "";
  const FR = [];
  walk(state.data, (n, p, d) => {
    if (p) {
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("class", "link");
      const c = curve(p.x, p.y, n.x, n.y);
      path.setAttribute("d", c);
      path.setAttribute("marker-end", "url(#arrow)");
      gLinks.appendChild(path);
    }
    FR.push({ n, p, d });
  });

  FR.forEach(({ n, p, d }) => {
    if (p && p.collapsed) return;
    const nodeG = el("g", {
      class: "node",
      transform: `translate(${n.x},${n.y})`,
      "data-id": n.id,
    });
    const r = Math.max(34 - d * 2, 20);
    const bubble = el("circle", { class: "bubble", r, cx: 0, cy: 0 });
    nodeG.appendChild(bubble);
    if (n.img) {
      const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
      img.setAttributeNS("http://www.w3.org/1999/xlink", "href", n.img);
      img.setAttribute("x", -30);
      img.setAttribute("y", r + 8);
      img.setAttribute("width", 100);
      img.setAttribute("height", 100);
      nodeG.appendChild(img);
    } else {
      const icon = el("text", { class: "label", x: 0, y: -8 });
      icon.textContent = n.icon || "📌";
      nodeG.appendChild(icon);
    }
    const title = el("text", { class: "label", x: 0, y: r - 10 });
    title.textContent = n.title;
    nodeG.appendChild(title);
    if (n.learned) {
      const bx = r - 6, by = -r + 6;
      const bR = 9;
      const badge = el("circle", { class: "badge", cx: bx, cy: by, r: bR });
      nodeG.appendChild(badge);
      const check = el("text", { class: "label", x: bx, y: by });
      check.textContent = "✓";
      nodeG.appendChild(check);
    }
    if (state.selectedId === n.id) {
      const sel = el("circle", {
        r: r + 6,
        cx: 0,
        cy: 0,
        fill: "none",
        stroke: "var(--accent-2)",
        "stroke-width": 2,
        "stroke-dasharray": "4 4",
      });
      nodeG.appendChild(sel);
    }
    gNodes.appendChild(nodeG);
  });
  refreshList();
  refreshSubtreeSelect();
  updateZoomLabel();
}

function curve(x1, y1, x2, y2) {
  const dx = (x2 - x1) * 0.3, dy = (y2 - y1) * 0.3;
  return `M ${x1} ${y1} C ${x1 + dx} ${y1 + dy}, ${x2 - dx} ${y2 - dy}, ${x2} ${y2}`;
}

function el(name, attrs) {
  const e = document.createElementNS("http://www.w3.org/2000/svg", name);
  for (const k in attrs) e.setAttribute(k, attrs[k]);
  return e;
}

let draggedNode = null;
let dragStart = null;

gNodes.addEventListener("pointerdown", (e) => {
  const g = e.target.closest("g.node");
  if (!g) return;
  const id = g.getAttribute("data-id");
  state.selectedId = id;
  draggedNode = findById(id); // Reference the correct node in state.data
  dragStart = { x: e.clientX, y: e.clientY };
  e.preventDefault();
});

svg.addEventListener("pointermove", (e) => {
  if (!draggedNode || !dragStart) return;
  const dx = (e.clientX - dragStart.x) / state.scale;
  const dy = (e.clientY - dragStart.y) / state.scale;
  draggedNode.x += dx;
  draggedNode.y += dy;
  dragStart = { x: e.clientX, y: e.clientY };
  render(); // Update the UI immediately
});

window.addEventListener("pointerup", () => {
  if (draggedNode) {
    save(); // Save updated positions into JSON
    render(); // Ensure UI reflects the updated data
  }
  draggedNode = null;
  dragStart = null;
});

let panStart = null;
svg.addEventListener("pointerdown", (e) => {
  if (e.target.closest("g.node")) return;
  panStart = { x: e.clientX - state.tx, y: e.clientY - state.ty };
  state.panning = true;
});
svg.addEventListener("pointermove", (e) => {
  if (!state.panning) return;
  state.tx = e.clientX - panStart.x;
  state.ty = e.clientY - panStart.y;
  applyView();
});
window.addEventListener("pointerup", () => {
  state.panning = false;
});

svg.addEventListener("wheel", (e) => {
  if (state.ctrlZoomOnly && !e.ctrlKey) return;
  e.preventDefault();
  const delta = Math.sign(e.deltaY) * -0.1;
  zoomAt(delta, e.clientX, e.clientY);
}, { passive: false });

$("#zoomIn").onclick = () => zoomAt(0.2, window.innerWidth - 40, 40);
$("#zoomOut").onclick = () => zoomAt(-0.2, window.innerWidth - 40, 40);

function zoomAt(amount, cx, cy) {
  const prev = state.scale;
  const next = clamp(prev + amount, 0.3, 2.5);
  const pt = screenToWorld(cx, cy);
  state.scale = next;
  const pt2 = worldToScreen(pt.x, pt.y);
  state.tx += cx - pt2.x;
  state.ty += cy - pt2.y;
  applyView();
  updateZoomLabel();
}

function updateZoomLabel() {
  $("#zoomLabel").textContent = Math.round(state.scale * 100) + "%";
}

function applyView() {
  state.tx = Math.max(-window.innerWidth * 0.5, Math.min(state.tx, window.innerWidth * 0.5));
  state.ty = Math.max(-window.innerHeight * 0.5, Math.min(state.ty, window.innerHeight * 0.5));
  viewport.setAttribute("transform", `translate(${state.tx},${state.ty}) scale(${state.scale})`);
}

function screenToWorld(x, y) {
  return { x: (x - state.tx) / state.scale, y: (y - state.ty) / state.scale };
}

function worldToScreen(x, y) {
  return { x: x * state.scale + state.tx, y: y * state.scale + state.ty };
}

const listEl = $("#list");
const searchEl = $("#search");

function refreshList() {
  const q = (searchEl.value || "").toLowerCase().trim();
  listEl.innerHTML = "";
  walk(state.data, (n, p, d) => {
    if (p && p.collapsed) return;
    if (q && !(n.title.toLowerCase().includes(q) || (n.note || "").toLowerCase().includes(q))) return;
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div style="font-size:20px">${n.icon || "📌"}</div>
      <div>
        <div><strong>${n.title}</strong> <span class="tiny">• độ sâu ${d}</span></div>
        <div class="meta">${n.note || ""}</div>
      </div>
      <div class="right">
        <label class="tiny row" style="gap:6px"><input type="checkbox" ${n.learned ? "checked" : ""} data-act="toggle"/> Đã học</label>
        <button class="btn small" data-act="center">Đến</button>
        <button class="btn small" data-act="collapse">${n.collapsed ? "Mở" : "Gập"}</button>
        <button class="btn small" data-act="edit">Sửa</button>
        <button class="btn small" style="background:var(--danger)" data-act="delete">Xoá</button>
      </div>`;
    item.querySelector('[data-act="toggle"]').onchange = () => {
      n.learned = !n.learned;
      save();
      render();
    };
    item.querySelector('[data-act="center"]').onclick = () => {
      state.selectedId = n.id;
      focusNode(n);
    };
    item.querySelector('[data-act="collapse"]').onclick = () => {
      n.collapsed = !n.collapsed;
      save();
      render();
    };
    item.querySelector('[data-act="edit"]').onclick = () => {
      openEditModal(n);
    };
    item.querySelector('[data-act="delete"]').onclick = () => {
      if (confirm("Bạn có chắc muốn xoá nút này?")) deleteNode(n.id);
    };
    listEl.appendChild(item);
  });
}

searchEl.addEventListener("input", refreshList);
window.addEventListener("keydown", (e) => {
  const tag = document.activeElement.tagName.toLowerCase();
  const typing = tag === "input" || tag === "textarea" || document.activeElement.isContentEditable;
  if (!typing && e.key === " " && state.selectedId) {
    e.preventDefault();
    const n = findById(state.selectedId);
    n.collapsed = !n.collapsed;
    render();
    save();
  }
});

function focusNode(n) {
  const pt = worldToScreen(n.x, n.y);
  state.tx += window.innerWidth * 0.5 - pt.x;
  state.ty += window.innerHeight * 0.5 - pt.y;
  applyView();
  render();
  save();
}

const fc = $("#fc");
const fcOverlay = $("#fc-overlay");
const subtreeSelect = $("#subtreeSelect");

function refreshSubtreeSelect() {
  const opts = [];
  walk(state.data, (n) => opts.push(n));
  subtreeSelect.innerHTML = opts.map(o => `<option value="${o.id}">${o.icon || "•"} ${o.title}</option>`).join("");
  if (state.selectedId) subtreeSelect.value = state.selectedId;
}

$("#btnStudy").onclick = () => {
  if (!state.selectedId) {
    alert("Vui lòng chọn một nút để học.");
    return;
  }
  const root = findById(state.selectedId);
  const cards = [root];
  let i = 0;
  fcOverlay.classList.add("visible");
  renderCard(cards, i);

  function renderCard(cards, i) {
    if (cards.length === 0) {
      fc.innerHTML = '<div class="tiny">Không có thẻ để học.</div>';
      return;
    }
    const c = cards[i];
    fc.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="big">${c.icon || "📌"} ${c.title}</div>
      ${c.img ? `<div class="image-container"><img src="${c.img}" alt="${c.title}" class="flashcard-image" /></div>` : ""}
      <div class="muted" style="white-space: pre-wrap;">${c.note || "(chưa có ghi chú)"}</div>
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <span class="tag">ID: ${c.id}</span>
        <span class="tag">${c.learned ? "ĐÃ HỌC" : "CHƯA HỌC"}</span>
      </div>
      <div class="row" style="margin-top:16px; gap:12px">
        <button class="btn" id="ok">Đánh dấu đã biết ✓</button>
        <button class="btn" id="next">Tiếp</button>
        <button class="btn" id="open">Tới nút</button>
      </div>`;
    fc.appendChild(wrap);

    const img = wrap.querySelector(".flashcard-image");
    if (img) {
      img.onclick = () => {
        const zoomedImg = document.createElement("div");
        zoomedImg.className = "zoomed-image-overlay";
        zoomedImg.innerHTML = `<div class="zoomed-image-container"><img src="${c.img}" alt="${c.title}" /><button class="btn close-zoom">Đóng</button></div>`;
        document.body.appendChild(zoomedImg);
        zoomedImg.querySelector(".close-zoom").onclick = () => document.body.removeChild(zoomedImg);
      };
    }

    $("#ok").onclick = () => {
      c.learned = true;
      const children = c.children || [];
      const allLearned = children.every(child => child.learned) && children.length > 0;
      if (allLearned || children.length === 0) {
        generateSubtreeQuiz(c);
      }
      save();
      render();
      renderCard(cards, i);
    };

    $("#next").onclick = () => {
      const children = c.children || [];
      if (children.length > 0 && i === 0) {
        children.forEach((child) => {
          if (!cards.find((card) => card.id === child.id)) {
            cards.push(child);
          }
        });
        i = 1;
      } else if (i > 0) {
        i = (i + 1) % cards.length;
      } else {
        alert("Không còn nút con nào để học!");
        return;
      }
      renderCard(cards, i);
    };

    $("#open").onclick = () => {
      state.selectedId = c.id;
      focusNode(c);
    };
  }
};

$("#close-fc").onclick = () => {
  fcOverlay.classList.remove("visible");
  $("#quiz-section").classList.remove("visible");
};

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function generateSubtreeQuiz(node) {
  const questions = [];
  walk(node, (n) => {
    if (n.questions && n.questions.length > 0) {
      n.questions.forEach((q, idx) => {
        questions.push({ ...q, nodeId: n.id, questionId: idx });
      });
    }
  });
  if (questions.length === 0) {
    questions.push({
      type: "multiple",
      question: `Câu hỏi trắc nghiệm về ${node.title}?`,
      options: ["A", "B", "C", "D"],
      answer: "A",
      nodeId: node.id,
      questionId: 0
    });
    node.questions = [{ type: "multiple", question: `Câu hỏi trắc nghiệm về ${node.title}?`, options: ["A", "B", "C", "D"], answer: "A" }];
  }
  renderQuiz(shuffleArray(questions));
}

function renderQuiz(questions) {
  const quizSection = $("#quiz-section");
  const quizQuestions = $("#quiz-questions");
  quizQuestions.innerHTML = "";
  
  if (questions.length === 0) {
    quizQuestions.innerHTML = '<div class="tiny">Không có câu hỏi nào.</div>';
    quizSection.classList.add("visible");
    return;
  }

  questions.forEach((q, idx) => {
    const div = document.createElement("div");
    div.style.marginBottom = "16px";
    div.innerHTML = `<p>Câu ${idx + 1}: ${q.question}</p>`;
    if (q.type === "multiple") {
      q.options.forEach((opt) => {
        div.innerHTML += `<label><input type="radio" name="quiz${idx}" value="${opt}">${opt}</label><br>`;
      });
    } else {
      div.innerHTML += `<input type="text" name="quiz${idx}" placeholder="Nhập đáp án">`;
    }
    if (q.img_answer) {
      div.innerHTML += `<br><img src="${q.img_answer}" alt="Hình ảnh câu hỏi" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
    }
    quizQuestions.appendChild(div);
  });

  quizSection.classList.add("visible");
  $("#quiz-submit").disabled = false;

  $("#quiz-submit").onclick = () => {
    let allCorrect = true;
    let feedback = "";
    questions.forEach((q, idx) => {
      const answerInput = q.type === "multiple" ? 
        document.querySelector(`input[name="quiz${idx}"]:checked`)?.value : 
        document.querySelector(`input[name="quiz${idx}"]`)?.value;
      const isCorrect = answerInput === q.answer;
      if (!isCorrect) allCorrect = false;
      feedback += `<p>Câu ${idx + 1}: ${q.question}<br>Đáp án của bạn: ${answerInput || "Chưa nhập"}<br>Đáp án đúng: ${q.answer}`;
      if (q.img_answer) {
        feedback += `<br><img src="${q.img_answer}" alt="Đáp án hình ảnh" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
      }
      feedback += `</p>`;
    });

    quizQuestions.innerHTML = feedback;
    $("#quiz-submit").disabled = true;
    alert(allCorrect ? "Đúng hết!" : "Có câu sai, hãy xem phản hồi!");
  };
}

$("#btnQuiz").onclick = () => {
  if (!state.selectedId) {
    alert("Vui lòng chọn một nút để kiểm tra.");
    return;
  }
  const root = findById(state.selectedId);
  generateSubtreeQuiz(root);
  fcOverlay.classList.add("visible");
};

$("#btnReset").onclick = () => {
  state.scale = 1;
  state.tx = window.innerWidth * 0.25;
  state.ty = window.innerHeight * 0.5;
  applyView();
  render();
};

const modalEdit = $("#modalEdit");

function addQuestionField(q, idx) {
  const questionFields = document.getElementById("questionFields");
  const div = document.createElement("div");
  div.className = "question-field";
  div.innerHTML = `
    <select name="qtype${idx}" class="input" style="margin: 5px 0;">
      <option value="multiple" ${q.type === "multiple" ? "selected" : ""}>Trắc nghiệm</option>
      <option value="fill" ${q.type === "fill" ? "selected" : ""}>Điền khuyết</option>
    </select>
    <input name="question${idx}" class="input" value="${q.question || ""}" placeholder="Câu hỏi" style="margin: 5px 0;" />
    ${
      q.type === "multiple"
        ? `
          <input name="option1${idx}" class="input" value="${q.options ? q.options[0] || "" : ""}" placeholder="Lựa chọn 1" style="margin: 5px 0;" />
          <input name="option2${idx}" class="input" value="${q.options ? q.options[1] || "" : ""}" placeholder="Lựa chọn 2" style="margin: 5px 0;" />
          <input name="option3${idx}" class="input" value="${q.options ? q.options[2] || "" : ""}" placeholder="Lựa chọn 3" style="margin: 5px 0;" />
          <input name="option4${idx}" class="input" value="${q.options ? q.options[3] || "" : ""}" placeholder="Lựa chọn 4" style="margin: 5px 0;" />
          <input name="answer${idx}" class="input" value="${q.answer || ""}" placeholder="Đáp án" style="margin: 5px 0;" />
        `
        : `<input name="answer${idx}" class="input" value="${q.answer || ""}" placeholder="Đáp án" style="margin: 5px 0;" />`
    }
    <input name="img_answer${idx}" class="input" value="${q.img_answer || ""}" placeholder="Link hình ảnh đáp án" style="margin: 5px 0;" />
    <button type="button" class="btn small" onclick="this.parentElement.remove()">Xóa</button>
  `;
  questionFields.insertBefore(div, document.getElementById("addQuestion"));
}

function openEditModal(node) {
  document.getElementById("editTitle").value = node.title || "";
  document.getElementById("editIcon").value = node.icon || "";
  document.getElementById("editNote").value = node.note || "";
  document.getElementById("editImg").value = node.img || "";
  const questionFields = document.getElementById("questionFields");
  questionFields.innerHTML = '<button type="button" id="addQuestion" class="btn small">Thêm câu hỏi</button>';

  const nodeQuestions = node.questions || [];
  nodeQuestions.forEach((q, idx) => addQuestionField(q, idx));

  modalEdit.showModal();

  document.getElementById("addQuestion").onclick = () => {
    addQuestionField({ type: "multiple", question: "", options: ["", "", "", ""], answer: "", img_answer: "" }, nodeQuestions.length);
  };

  document.getElementById("btnEditNodeModal").onclick = () => {
    const title = document.getElementById("editTitle").value.trim();
    const icon = document.getElementById("editIcon").value.trim();
    const note = document.getElementById("editNote").value.trim();
    const img = document.getElementById("editImg").value.trim();
    if (!title) {
      alert("Bạn phải nhập tiêu đề!");
      return;
    }
    node.title = title;
    node.icon = icon;
    node.note = note;
    if (img) node.img = img;

    node.questions = [];
    const questionDivs = questionFields.querySelectorAll(".question-field");
    questionDivs.forEach((div, idx) => {
      const type = div.querySelector(`select[name="qtype${idx}"]`).value;
      const question = div.querySelector(`input[name="question${idx}"]`).value.trim();
      if (!question) return;
      if (type === "multiple") {
        const options = [
          div.querySelector(`input[name="option1${idx}"]`).value.trim(),
          div.querySelector(`input[name="option2${idx}"]`).value.trim(),
          div.querySelector(`input[name="option3${idx}"]`).value.trim(),
          div.querySelector(`input[name="option4${idx}"]`).value.trim(),
        ].filter((opt) => opt);
        const answer = div.querySelector(`input[name="answer${idx}"]`).value.trim();
        const img_answer = div.querySelector(`input[name="img_answer${idx}"]`).value.trim();
        if (options.length >= 2 && answer) {
          node.questions.push({ type, question, options, answer, img_answer });
        }
      } else {
        const answer = div.querySelector(`input[name="answer${idx}"]`).value.trim();
        const img_answer = div.querySelector(`input[name="img_answer${idx}"]`).value.trim();
        if (answer) {
          node.questions.push({ type, question, answer, img_answer });
        }
      }
    });

    save();
    render();
    modalEdit.close();
  };
}

function deleteNode(id) {
  if (id === state.data.id) {
    if (confirm("Bạn có chắc muốn xoá nút gốc và tạo lại mới?")) {
      state.data = {
        id: "root_" + Math.random().toString(36).slice(2, 6),
        title: "Nút gốc mới",
        icon: "🌱",
        note: "Đây là nút gốc mới",
        x: 0,
        y: 0,
        collapsed: false,
        learned: false,
        children: [],
        questions: []
      };
      state.selectedId = state.data.id;
      save();
      render();
    }
    return;
  }
  let deleted = false;
  walk(state.data, (n, p) => {
    if (!n || !p || !p.children) return;
    const idx = p.children.findIndex((c) => c.id === id);
    if (idx !== -1) {
      p.children.splice(idx, 1);
      deleted = true;
    }
  });
  if (deleted) {
    state.selectedId = state.data.id;
    save();
    render();
  }
}

$("#zoomReset").onclick = () => {
  state.scale = 1;
  state.tx = window.innerWidth * 0.25;
  state.ty = window.innerHeight * 0.5;
  applyView();
  render();
};

let lastTouchDistance = null;
svg.addEventListener("touchstart", (e) => {
  if (e.touches.length === 2) lastTouchDistance = getTouchDistance(e.touches);
});
svg.addEventListener("touchmove", (e) => {
  if (e.touches.length === 2 && lastTouchDistance !== null) {
    e.preventDefault();
    const currentDistance = getTouchDistance(e.touches);
    const delta = (currentDistance - lastTouchDistance) / 200;
    zoomAt(delta, e.touches[0].clientX, e.touches[0].clientY);
    lastTouchDistance = currentDistance;
  }
}, { passive: false });
svg.addEventListener("touchend", () => {
  lastTouchDistance = null;
});

function getTouchDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

function clamp(v, min, max) {
  return Math.min(Math.max(v, min), max);
}

async function init() {
  await load();
  state.tx = window.innerWidth * 0.25;
  state.ty = window.innerHeight * 0.5;
  state.scale = 1;
  applyView();
  render();
  state.selectedId = state.data.id;
  refreshList();
  refreshSubtreeSelect();
  window.addEventListener("keydown", (e) => {
    if (e.key.toLowerCase() === "l" && state.selectedId) {
      const n = findById(state.selectedId);
      n.learned = !n.learned;
      save();
      render();
    }
  });
  window.addEventListener("resize", () => render());
  const sidebar = $("#sidebar");
  const toggleBtn = $("#toggleSidebar");
  toggleBtn.onclick = () => {
    sidebar.classList.toggle("visible");
    toggleBtn.textContent = sidebar.classList.contains("visible") ? "◀" : "▶";
  };
  $("#saveJson").onclick = () => downloadFile();
}

init();
    </script>
  </body>
</html>
